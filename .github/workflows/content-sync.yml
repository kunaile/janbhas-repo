name: Smart Content Sync

on:
  push:
    branches: [main]
    paths: ['content/**/*.md', 'content/**/*.mdx']

permissions:
  contents: read
  actions: read

concurrency:
  group: content-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  NODE_ENV: production

jobs:
  sync-changed-content:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'publish')
    timeout-minutes: 15

    steps:
      - name: ðŸ” Verify authorization
        run: |
          AUTHORIZED_USERS="${{ secrets.AUTHORIZED_SYNC_USERS }}"
          CURRENT_USER="${{ github.event.head_commit.author.username }}"
          
          if [[ -z "$AUTHORIZED_USERS" || "$AUTHORIZED_USERS" != *"$CURRENT_USER"* ]]; then
            echo "âŒ Unauthorized sync attempt by: $CURRENT_USER"
            exit 1
          fi

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Analyze changes
        id: changes
        run: |
          echo "ðŸ” Analyzing commit: ${{ github.event.head_commit.message }}"

          # Detect file changes
          CHANGED_FILES=$(git diff -M --name-only --diff-filter=AMR HEAD~1 HEAD | grep -E '^content/.*\.(md|mdx)$' || true)
          REMOVED_FILES=$(git diff -M --name-only --diff-filter=D HEAD~1 HEAD | grep -E '^content/.*\.(md|mdx)$' || true)
          
          # Also detect renames specifically
          RENAMED_FILES=$(git diff -M --name-status HEAD~1 HEAD | grep '^R' | cut -f3 | grep -E '^content/.*\.(md|mdx)$' || true)
          
          # Combine all changes
          ALL_CHANGES=$(printf '%s\n%s\n%s' "$CHANGED_FILES" "$REMOVED_FILES" "$RENAMED_FILES" | grep -v '^$' | sort -u)
          TOTAL_CHANGES=$(echo "$ALL_CHANGES" | grep -v '^$' | wc -l)
          
          # Extract languages dynamically
          DETECTED_LANGUAGES=""
          VERNACULAR_LANGUAGES=""
          
          for file in $ALL_CHANGES; do
            if [[ "$file" =~ ^content/([^/]+)/ ]]; then
              LANG="${BASH_REMATCH[1]}"
              if [[ ! "$DETECTED_LANGUAGES" =~ (^|[[:space:]])$LANG($|[[:space:]]) ]]; then
                DETECTED_LANGUAGES="$DETECTED_LANGUAGES $LANG"
                [ "$LANG" != "en" ] && VERNACULAR_LANGUAGES="$VERNACULAR_LANGUAGES $LANG"
              fi
            fi
          done
          
          DETECTED_LANGUAGES=$(echo "$DETECTED_LANGUAGES" | xargs)
          VERNACULAR_LANGUAGES=$(echo "$VERNACULAR_LANGUAGES" | xargs)
          
          echo "ðŸ“Š $TOTAL_CHANGES files | Languages: ${DETECTED_LANGUAGES:-none}"
          
          # Set outputs and environment
          echo "total-changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          echo "detected-languages=$DETECTED_LANGUAGES" >> $GITHUB_OUTPUT
          echo "vernacular-languages=$VERNACULAR_LANGUAGES" >> $GITHUB_OUTPUT
          
          # Set environment variables for the sync script
          {
            echo "CHANGED_FILES<<EOF"
            echo "$CHANGED_FILES"
            echo "EOF"
            echo "REMOVED_FILES<<EOF"
            echo "$REMOVED_FILES" 
            echo "EOF"
            echo "RENAMED_FILES<<EOF"
            echo "$RENAMED_FILES"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: âœ… Validate environment
        if: steps.changes.outputs.total-changes != '0'
        run: |
          [ -z "${{ secrets.DATABASE_URL }}" ] && { echo "âŒ Missing DATABASE_URL"; exit 1; }

      - name: âš™ï¸ Setup Node.js
        if: steps.changes.outputs.total-changes != '0'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Setup pnpm
        if: steps.changes.outputs.total-changes != '0'
        uses: pnpm/action-setup@v4
        with:
          version: 10.5.2

      - name: ðŸ—‚ï¸ Cache dependencies
        if: steps.changes.outputs.total-changes != '0'
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸ“‹ Install dependencies
        if: steps.changes.outputs.total-changes != '0'
        run: pnpm install --frozen-lockfile --silent

      - name: ðŸ”„ Validate mappings
        if: steps.changes.outputs.total-changes != '0'
        run: |
          VERNACULAR_LANGUAGES="${{ steps.changes.outputs.vernacular-languages }}"
          MISSING_FILES=""
          
          if [ -n "$VERNACULAR_LANGUAGES" ]; then
            for lang in $VERNACULAR_LANGUAGES; do
              for type in author-mappings category-mappings tag-mappings; do
                file="src/data/${type}.${lang}.json"
                if [ ! -f "$file" ] || ! jq empty "$file" 2>/dev/null; then
                  MISSING_FILES="$MISSING_FILES $file"
                fi
              done
            done
            
            if [ -n "$MISSING_FILES" ]; then
              echo "âŒ Missing/invalid mapping files:$MISSING_FILES"
              echo "ðŸ’¡ Create valid JSON mapping files for languages: $VERNACULAR_LANGUAGES"
              exit 1
            fi
            
            echo "âœ… Mappings validated for: $VERNACULAR_LANGUAGES"
          else
            echo "âœ… English-only content, no mappings needed"
          fi

      - name: ðŸš€ Sync content
        if: steps.changes.outputs.total-changes != '0'
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 8
          max_attempts: 3
          retry_on: error
          command: pnpm sync:github
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
          COMMIT_AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          COMMIT_AUTHOR_USERNAME: ${{ github.event.head_commit.author.username }}

      - name: ðŸ“Š Report results
        if: always() && steps.changes.outputs.total-changes != '0'
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… Sync Completed" >> $GITHUB_STEP_SUMMARY
            echo "- **Files:** ${{ steps.changes.outputs.total-changes }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Languages:** ${{ steps.changes.outputs.detected-languages }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Author:** ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode:** Dynamic mapping-based" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Sync Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Files:** ${{ steps.changes.outputs.total-changes }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Languages:** ${{ steps.changes.outputs.detected-languages }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common fixes:**" >> $GITHUB_STEP_SUMMARY
            echo "- Missing mappings: \`src/data/{type}.{lang}.json\`" >> $GITHUB_STEP_SUMMARY
            echo "- Series order: Process covers before episodes" >> $GITHUB_STEP_SUMMARY
            echo "- Field names: Use \`series_title\`, \`sub_category\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ› Debug info
        if: failure()
        run: |
          echo "âŒ FAILURE DEBUG:"
          echo "Files: ${{ steps.changes.outputs.total-changes }}"
          echo "Languages: ${{ steps.changes.outputs.detected-languages }}"
          echo "Vernacular: ${{ steps.changes.outputs.vernacular-languages }}"
          echo "Author: ${{ github.event.head_commit.author.username }}"
          echo ""
          echo "Mapping files:"
          find src/data -name "*-mappings.*.json" 2>/dev/null | head -5 || echo "None found"
